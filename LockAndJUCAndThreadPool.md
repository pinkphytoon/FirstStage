# å¤ä¹ 

## å¤šçº¿ç¨‹çš„åˆ›å»ºæ–¹å¼

### ç»§æ‰¿Threadç±»

```java
public class SonThread extends Thread{
	public void run(){
	æ“ä½œå¤šçº¿ç¨‹çš„ä»£ç ï¼›
	}
}
public class SonThreadTest{
	public static void main(String[] args){
	SonThread st = new SonThread();
	st.start();
	}
}
```

### å®ç°ç±»Runnableæ¥å£

```java
public class SonRunnableImpl implements Thread{
	public void run(){
		æ“ä½œå¤šçº¿ç¨‹çš„ä»£ç ;
	}
}

public class SonRunnableImplTest{
	public static void main(String[] args){
        Runnable r = new SonRunnableImpl();
        Thread t = new Thread(r);
    	t.start();
	}
}
```

### Threadç±»ä¸­çš„API

```java
// æ— å‚æ„é€ å™¨
public Thread();

// æœ‰å‚æ„é€ å™¨ï¼Œä¸»è¦ç”¨äºä¸Runnableæ¥å£å¯¹è±¡å»ºç«‹å…³è”
public Thread(Runnable r);

// æœ‰å‚æ„é€ å™¨ï¼Œä¸»è¦ç”¨äºä¸Callableæ¥å£å¯¹è±¡å»ºç«‹å…³è”
public Thread(Callable c);

// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ï¼Œä¸»è¦ç”¨äºRunnableæ¥å£å®ç°ç±»ä¸­
public static Thread currentThread();

// è®©å½“å‰çº¿ç¨‹ç¡çœ æŒ‡å®šæ¯«ç§’æ•°
public static void sleep(long millis);

// ç¼–å†™å¤šçº¿ç¨‹æ“ä½œä»£ç 
public void run();

// å¼€å¯å¤šçº¿ç¨‹æ“ä½œï¼Œå¹¶è°ƒç”¨é‡å†™çš„runæ–¹æ³•
public void start();
```

## å¤šçº¿ç¨‹ä»£ç å®‰å…¨éšæ‚£é—®é¢˜

### å‰æï¼š

### 1ã€å¿…é¡»æ˜¯å¤šçº¿ç¨‹æ“ä½œ

### 2ã€å¤šä¸ªçº¿ç¨‹å¿…é¡»æ“ä½œå…±åŒèµ„æº

## è§£å†³æ–¹å¼ï¼š

### 1ã€åŒæ­¥ä»£ç å—

```java
public void run(){
	synchronized(ç±»å.class){
		æ“ä½œå¤šçº¿ç¨‹çš„ä»£ç ;
	}
}
```

### 2ã€åŒæ­¥å‡½æ•°

```java
public void run(){
	this.æ–¹æ³•å();
}

public synchronized void æ–¹æ³•å(){
	æ“ä½œå¤šçº¿ç¨‹ä»£ç ;
}
```

## ä½¿ç”¨synchroniazdä¿®é¥°ç¬¦å®ç°ï¼Œä¼šè‡ªåŠ¨â€œä¸Šé”â€å’Œâ€œè§£é”â€



# é¢è¯•é¢˜

## ç®€è¿°ä»€ä¹ˆæ˜¯å¹¶è¡Œå’Œå¹¶å‘ï¼Ÿ

### 1ã€å¹¶å‘ï¼šå•æ ¸æ“ä½œï¼Œæ•°æ®é‡è¾ƒå°çš„æ“ä½œï¼ŒæŒ‰ç…§é¡ºåºæ‰§è¡Œ

### 2ã€å¹¶è¡Œï¼šå¤šæ ¸æ“ä½œï¼Œæ•°æ®é‡è¾ƒå¤§çš„æ“ä½œï¼Œéšæœºæ‰§è¡Œ



## ç®€è¿°å¤šçº¿ç¨‹åˆ›å»ºæ–¹å¼æœ‰å“ªäº›ï¼Ÿå¦‚ä½•å¼€å¯å¤šçº¿ç¨‹ï¼Ÿä¸åŒæ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼Ÿå®é™…å¼€å‘ä¸­æ›´æ¨èä½¿ç”¨é‚£ç§ï¼Ÿ

### 1ã€åˆ›å»ºæ–¹å¼ï¼šç»§æ‰¿Threadç±»ã€å®ç°Runnableæ¥å£ã€å®ç°Callableæ¥å£

### 2ã€é€šè¿‡Threadç±»å¯¹è±¡è°ƒç”¨startæ–¹æ³•å¼€å¯å¤šçº¿ç¨‹

### 3ã€ä¼˜ç¼ºç‚¹ï¼š

#### 		ï¼ˆ1ï¼‰ç»§æ‰¿ï¼š

#### 				ä¼˜åŠ¿ï¼šç”±äºæ˜¯ç»§æ‰¿å…³ç³»ï¼Œå­ç±»å¯ä»¥ç›´æ¥è°ƒç”¨çˆ¶ç±»æ“ä½œçº¿ç¨‹çš„æ–¹æ³•

#### 				ä¸è¶³ï¼šç”±äºæ˜¯ç»§æ‰¿å…³ç³»ï¼Œä¸€å®šæˆéƒ½å¯¼èˆªæé«˜ç±»ä¸ç±»ä¹‹é—´çš„è€¦åˆåº¦

#### 		ï¼ˆ1ï¼‰å®ç°ï¼š

#### ä¼˜åŠ¿ï¼šä¸€å®šç¨‹åº¦ä¸Šé™ä½è€¦åˆåº¦ï¼Œé¿å…Javaä¸­å•ç»§æ‰¿å±€é™æ€§

#### 				ä¸è¶³ï¼šå¿…é¡»å…ˆä¸Threadç±»å»ºç«‹å…³è”ï¼Œè°ƒç”¨æ¯”è¾ƒéº»çƒ¦



## å¤šçº¿ç¨‹çš„çŠ¶æ€å’Œä¸åŒçŠ¶æ€ä¸‹æ‰€å…·å¤‡çš„æƒé™

| çŠ¶æ€     | æƒé™                       |
| -------- | -------------------------- |
| åˆ›å»ºçŠ¶æ€ | åªæœ‰ç”Ÿå­˜æƒ                 |
| è¿è¡ŒçŠ¶æ€ | æ—¢æœ‰ç”Ÿå­˜æƒï¼Œä¹Ÿæœ‰æ‰§è¡Œæƒ     |
| æ¶ˆäº¡çŠ¶æ€ | æ—¢æ²¡æœ‰ç”Ÿå­˜æƒï¼Œä¹Ÿæ²¡æœ‰æ‰§è¡Œæƒ |
| é˜»å¡çŠ¶æ€ | åªæœ‰ç”Ÿå­˜æƒï¼Œæ²¡æœ‰æ‰§è¡Œæƒ     |



## åˆ›å»ºçŠ¶æ€å’Œé˜»å¡çŠ¶æ€ä¸‹çš„ç”Ÿå­˜æƒçš„åŒºåˆ«

### åˆ›å»ºçŠ¶æ€å¤šçº¿ç¨‹æ²¡æœ‰å¼€å¯ï¼›é˜»å¡çŠ¶æ€å¤šçº¿ç¨‹è¢«å¼€å¯ï¼Œä½†æ˜¯æ²¡æœ‰â€œæŠ¢åˆ°â€CPUæ‰§è¡Œæƒ

## 

## å¤„äºé˜»å¡çŠ¶æ€ä¸‹çš„çº¿ç¨‹å­˜å‚¨çš„ä½ç½®ï¼Ÿè¿›å‡ºåŸåˆ™ï¼Ÿ

### å¤„äºé˜»å¡çŠ¶æ€ä¸‹çš„çº¿ç¨‹åœ¨JVMæä¾›çš„çº¿ç¨‹æ± ä¸­ï¼Œéµå¾ªå…ˆè¿›å…ˆå‡ºçš„åŸåˆ™



## ç®€è¿°javaä¸­è§£å†³å¤šçº¿ç¨‹ä»£ç å®‰å…¨éšæ‚£é—®é¢˜çš„æ–¹å¼æœ‰å“ªäº›ï¼ŸåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿé€‚ç”¨åœºæ™¯

### 	â‘ æ–¹å¼ï¼šåŒæ­¥ä»£ç å— å’Œ åŒæ­¥å‡½æ•°

### 	â‘¡åŒºåˆ«ï¼šâ€œé”â€ä¸åŒ

### 		åŒæ­¥å‡½æ•°ï¼šåªæ”¯æŒæœ¬ç±»å¯¹è±¡é”ï¼ˆå³thiså…³é”®å­—ï¼‰

### 		åŒæ­¥ä»£ç å—ï¼šä»»æ„å¯¹è±¡é”ï¼ˆå³Objectå¯¹è±¡ï¼‰ã€æœ¬ç±»å¯¹è±¡é”ï¼ˆå³thiså…³é”®å­—ï¼‰ã€åå°„æœºåˆ¶é”ï¼ˆå³ç±»å.classï¼‰

### 	â‘¢é€‚ç”¨åœºæ™¯ï¼šè¦æ ¹æ®ç”¨æˆ·çš„å®é™…éœ€æ±‚è¿›è¡Œå…·ä½“é—®é¢˜å…·ä½“åˆ†æ

### 		å½“ä¸šåŠ¡é€»è¾‘è¾ƒå°‘æ—¶ï¼Œæ¨èåœ¨runæ–¹æ³•ä¸­ç›´æ¥å®šä¹‰åŒæ­¥ä»£ç å—ï¼Œä¸éœ€è¦å†æ¬¡è°ƒç”¨ï¼Œâ€œé”â€çš„æ ·å¼è¾ƒå¤š

### 		å½“ä¸šåŠ¡é€»è¾‘è¾ƒå¤æ‚æ—¶ï¼Œæ¨èè‡ªå®šä¹‰åŒæ­¥å‡½æ•°ï¼Œç®€åŒ–runæ–¹æ³•ä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯åƒä¸‡ä¸è¦å¿˜è®°åœ¨runæ–¹æ³•ä¸­è°ƒç”¨

# ====================

# å®ç°Callableæ¥å£åˆ›å»ºå¤šçº¿ç¨‹

## ä¸ºå•¥å­¦è¿™ä¸ªï¼Ÿåœ¨ä¼ ç»Ÿç»§æ‰¿Threadç±»æˆ–å®ç°Runnableæ¥å£æ—¶éƒ½æ˜¯å¯¹runæ–¹æ³•çš„é‡å†™ï¼Œç”±äºrunæ–¹æ³•æ—¢ä¸èƒ½ä¼ å‚ï¼Œä¹Ÿä¸èƒ½æœ‰è¿”å›å€¼ï¼›å½“è®¸å“¦çº¿ç¨‹æ“ä½œç»“æœï¼Œåœ¨æœªæ¥æŸä¸€æ—¶åˆ»ä½¿ç”¨æ—¶ï¼Œrunæ–¹æ³•æ— æ³•å®Œæˆæ—¶ï¼Œjavaæå‡ºCallableæ¥å£ï¼Œé’ˆå¯¹æ²¡æœ‰è¿”å›å€¼çš„ï¼Œæ¯”å¦‚ï¼šç°åœ¨çš„ç»“æœä¸æƒ³ç”¨ï¼Œä»¥ååœ¨ç”¨



# æ‹“å±•ï¼š

## JUC =>java.util.concurrent,è¿™å°±æ˜¯é€šå¸¸æ‰€æœ‰è¯´çš„ä½¿ç”¨JUCæ–¹å¼è§£å†³å¤šçº¿ç¨‹é—®é¢˜ï¼Œå°†æ“ä½œå¤šçº¿ç¨‹çš„ç±»å®šä¹‰åœ¨JUCåŒ…ä¸‹



# éœ€æ±‚:ä½¿ç”¨Callableæ¥å£ å’Œ FutureTaskç±»åˆ›å»ºçº¿ç¨‹ï¼Œå®Œæˆ[1,100]çš„æ±‚å’Œè¿ç®—

```java
/*
* åˆ›å»ºç±»å®ç°Callableæ¥å£
* */
public class MyCall implements Callable {

    @Override
    public Integer call() throws Exception {
        //ä¸€ä¸ªå®ç°äº†Callable<Integer>æ¥å£çš„åŒ¿åç±»çš„å®ä¾‹
        System.out.println("å¤šçº¿ç¨‹è®¡ç®—[1,100]çš„å’Œ");
        int sum = 0;
        for (int i = 0; i < 101; i++) {
            sum += i;
        }
        return sum;
    }
}
```

```java
//æµ‹è¯•ç±»
public class MyCallTest {
    public static void main(String[] args) {
        //å®ä¾‹åŒ–Callableæ¥å£å¯¹è±¡
        Callable<Integer> call = new MyCall();
        //å®ä¾‹åŒ–FutureTaskç±»å¯¹è±¡,å°†Callableæ¥å£å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’
        FutureTask<Integer> task = new FutureTask<>(call);
        //åˆ›å»ºThreadç±»ï¼Œå°†FutureTaskç±»å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œè°ƒç”¨startæ–¹æ³•
        Thread t = new Thread(task);
        t.start();
        /*
         * ç”±äºå¤šçº¿ç¨‹æ“ä½œæ—¶å®šä¹‰åœ¨Callableæ¥å£å®ç°ç±»çš„callæ–¹æ³•ä¸­
         * éœ€è¦é€šè¿‡FutureTaskç±»å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œè·å–
         * public Object get();
         * */
        try {
            Integer sum = task.get();
            System.out.println("sum = " + sum);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        }
    }
}
```

![image-20240716202724000](img/image-20240716202724000.png)

## æ€»ç»“ï¼š

### 1ã€åˆ›å»ºç±»å®ç°Callableæ¥å£ï¼Œå¹¶é‡å†™callæ–¹æ³•ï¼ˆç­‰ä»·å®ç°Runnableæ¥å£ï¼Œé‡å†™runæ–¹æ³•ï¼‰ï¼Œå¯ä»¥è‡ªå®šä¹‰è¿”å›å€¼ç»“æœç±»å‹

### 2ã€å®ä¾‹åŒ–FutureTaskç±»å¯¹è±¡ï¼Œå¹¶å°†Callableæ¥å£å®ç°ç±»å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå»ºç«‹å…³è”

### 3ã€åˆ›å»ºå®ä¾‹åŒ–Threadç±»å¯¹è±¡ï¼Œå¹¶å°†FutureTaskç±»å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå»ºç«‹å…³è”

### 4ã€ç”¨Threadç±»å¯¹è±¡è°ƒç”¨startæ–¹æ³•å¼€å¯å¤šçº¿ç¨‹

### 5ã€é€šè¿‡FutureTaskç±»å¯¹è±¡è°ƒç”¨getæ–¹æ³•è·å–callæ–¹æ³•æ“ä½œç»“æœ

## å°ç»“:ä¸‰ç§åˆ›å»ºå¤šçº¿ç¨‹çš„æ–¹å¼å¯¹æ¯”ï¼Œå®ç°Callableæ¥å£å’ŒFutureTaskç±»ç»„åˆçš„æ–¹å¼æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯åœ¨é‡å†™callæ–¹æ³•æ—¶å¯ä»¥è‡ªå®šä¹‰è¿”å›å€¼ç±»å‹ï¼Œä¹Ÿå¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼›åœ¨å¤šçº¿ç¨‹æ“ä½œå®Œæˆåï¼Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­éœ€è¦ä½¿ç”¨æ“ä½œç»“æœæ—¶ï¼Œå¯ä»¥éšæ—¶è·å–ï¼Œå…¶ä»–ä¸¤ç§æ–¹æ³•å°±ä¸è¡Œäº†ï¼ï¼ï¼


# Locké”æ¥å£

## å¤ä¹ ï¼šsynchroniazdä¿®é¥°é”ï¼Œæ— éœ€åˆ›å»ºç›´æ¥ä½¿ç”¨ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œç§°ä¹‹ä¸ºéšå¼ğŸ”’ï¼Œä¼šè‡ªåŠ¨â€œä¸Šé”â€ å’Œ é‡Šæ”¾ğŸ”’

## Locké”æ¥å£ï¼šç§°ä¹‹ä¸ºæ˜¾ç¤ºğŸ”’ï¼Œéœ€è¦è°ƒç”¨è€…æ‰‹åŠ¨åˆ›å»ºï¼Œå¹¶æ‰‹åŠ¨â€œä¸Šé”â€ å’Œ é‡Šæ”¾é”

```java
public class SaleWindow implements Runnable {
    private int eat = 10;
    //å®ä¾‹åŒ–Locké”æ¥å£å¯¹è±¡ï¼Œæ‰‹åŠ¨åˆ›å»ºä¸€æŠŠğŸ”’
    private Lock lock = new ReentrantLock();
    
    @Override
    public void run() {
        //å‡è®¾10äººæ’é˜Ÿä¹°ç…é¥¼æœå­
        for (int i = 0; i < 11; i++) {
            //â€ä¸Šé”â€œ => public void lock();
            lock.lock();
            /*
            * å¼€é”çš„åŠ¨ä½œï¼šæ— è®ºæ˜¯å¦ä¹°è´­ä¹°æˆåŠŸéƒ½è¦æ‰§è¡Œçš„æ“ä½œï¼ŒSo
            * éœ€è¦å®šä¹‰åœ¨finallyå—ä¸­ï¼Œè€Œfinallå—ä¸­ä¸èƒ½å•ç‹¬å®šä¹‰
            * å› æ­¤è‡³å°‘å®šä¹‰ä¸€ä¸ªï¼Œtryå—é¢„ç½®é…åˆä½¿ç”¨
            * */
            try{
                if (eat > 0) {
                    eat--;
                    System.out.println(Thread.currentThread() + "å–å‡ºä¸€å¼ ç…é¥¼æœå­ï¼Œå‰©ä½™" + eat + "å¼ ç…é¥¼æœå­");
                }
            }finally {
                //å¼€é” => public void unlock();
                lock.unlock();
            }
        }
    }
}
```

```java
public class SaleWindowTest {
    public static void main(String[] args) {
        Runnable r = new SaleWindow();
        Thread t0 = new Thread(r);
        Thread t1 = new Thread(r);
        Thread t2 = new Thread(r);
        t0.start();
        t1.start();
        t2.start();
    }
}
```

![image-20240716203631081](img/image-20240716203631081.png)





# Locké”æ¥å£å®ç°ç±»ReentrantLockç±»è¯¦è§£

## å¯é‡å…¥äº’æ–¥é”ï¼Œæ˜¯ä¸€ä¸ªæ˜¾å¼é”ï¼Œå…·å¤‡synchroniazedä¿®é¥°ç¬¦ç›¸åŒä½œç”¨ï¼ŒåŠŸèƒ½å¼ºå¤§

## äº’æ–¥é”ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½ä½¿ç”¨

## å¯é‡å…¥ï¼šæ„å‘³ç€åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–è¿™ä¸ªğŸ”’ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰æ‹¥æœ‰è¿‡è€Œé˜»å¡ï¼›è¿™ç§æœºåˆ¶å¯ä»¥é˜²æ­¢â€æ­»â€œé”ï¼ˆğŸ”’ä¸­ğŸ”’ï¼‰çš„æ“ä½œï¼Œå¯ä»¥æé«˜ä»£ç çš„çµæ´»æ€§å’Œå®‰å…¨æ€§





# ä¼ä¸šçº§å¤šçº¿ç¨‹ç¼–ç è§„èŒƒ

## åˆ›å»ºå¤šçº¿ç¨‹çš„æ–¹æ³•å­˜åœ¨çš„é—®é¢˜ï¼š

### 1ã€ç»§æ‰¿Threadç±»:çº¿ç¨‹ç±»ï¼Œç”¨äºåˆ›å»ºå¤šçº¿ç¨‹ï¼Œå¼€å¯å¤šçº¿ç¨‹æ‰§è¡Œ

### 2ã€å®ç°Runnableæ¥å£/å®ç°Callableæ¥å£ï¼šåªæä¾›å®ç°æ“ä½œå¤šçº¿ç¨‹çš„æ–¹æ³•ï¼Œéœ€è¦å’ŒThread ç±»å»ºç«‹å…³è”ï¼Œæ‰èƒ½å®ç°å¤šçº¿ç¨‹çš„æ“ä½œ

### 3ã€ä»¥ä¸Š3ç§åˆ›å»ºå¤šçº¿ç¨‹çš„æ–¹å¼éƒ½æ˜¯å…±åŒèµ„æºå®šä¹‰åœ¨å¤šçº¿ç¨‹å®ç°ç±»ä¸­ï¼Œè´£ä»»ä¸æ˜ç¡®ï¼Œä¼ä¸šå¼€å‘ä¼šå°†èµ„æºå•ç‹¬å°è£…ï¼ˆè¾¾åˆ°è´£ä»»åˆ†ç¦»~ï¼‰

```java
/*
 * èµ„æºç±»å°è£…
 * */
public class Ticket {
    //ç§æœ‰å˜é‡countç”¨äºè¡¨ç¤ºç…é¥¼æœå­çš„æ•°é‡ï¼Œåˆå§‹å€¼ä¸º8
    private int count = 8;
    //ğŸ”’çš„æ˜¯èµ„æºï¼Œå«ç”Ÿé—´éƒ½åœ¨é‡Œé¢é”çš„ï¼Œæ“ä½œå®Œä¹‹åæ‰é‡Šæ”¾
    //å®ä¾‹åŒ–Lockæ¥å£å¯¹è±¡,ç”¨äºå®ç°çº¿ç¨‹åŒæ­¥æ§åˆ¶ã€‚
    private Lock lock = new ReentrantLock();

    //è‡ªå®šä¹‰å–æœå­çš„æ–¹æ³•
    public void saleTick() {
        //å…³é” - è°ƒç”¨lock.lock()æ¥è·å–é”
        /*
         *ç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œè¯¥æ–¹æ³•å†…çš„ä»£ç å—
         * */
        lock.lock();
        try {
            if (count > 0) {
                //ç„¶åï¼Œæ£€æŸ¥countæ˜¯å¦å¤§äº0
                count--;
                System.out.println(Thread.currentThread().getName() + "::å–å‡ºä¸€å¼ ç…é¥¼æœå­ï¼Œå‰©ä½™" + count + "å¼ ç…é¥¼æœå­");
                //å¹¶è¾“å‡ºå½“å‰çº¿ç¨‹åå’Œå‰©ä½™çš„ç…é¥¼æœå­æ•°é‡ã€‚
            }
        } finally {
            //å¼€é” - åœ¨finallyä»£ç å—ä¸­é‡Šæ”¾é”ï¼Œå³è°ƒç”¨lock.unlock()ã€‚
            lock.unlock();
        }
    }
}
         /*
          * è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨æ˜¯æ¨¡æ‹Ÿç…é¥¼æœå­çš„é”€å”®è¿‡ç¨‹ï¼Œé€šè¿‡åŠ é”
          * å’Œè§£é”æ¥ä¿è¯å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶çš„çº¿ç¨‹å®‰å…¨ã€‚
          * */
```

```java
/*
 * åˆ›å»ºç±»å®ç°å¤šçº¿ç¨‹æ“ä½œ
 * */
public class SaleTickWindow implements Runnable {
//ä¸€ä¸ªåä¸ºSaleTickWindowçš„ç±»ï¼Œå®ƒå®ç°äº†Runnableæ¥å£ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥è¢«ç”¨ä½œä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚

    private Ticket ticket;
    //ä¸€ä¸ªç§æœ‰æˆå‘˜å˜é‡ticketï¼Œå®ƒæ˜¯Ticketç±»å‹çš„å¯¹è±¡ã€‚
    //è¿™ä¸ªå¯¹è±¡æ˜¯é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥çš„ï¼Œè¡¨ç¤ºè¯¥çª—å£ä¾èµ–ä¸€ä¸ªTicketå¯¹è±¡æ¥è¿›è¡Œç…é¥¼æœå­çš„é”€å”®æ“ä½œã€‚

    public SaleTickWindow(Ticket ticket) {
        //åˆ›å»ºSaleTickWindowå¯¹è±¡æ—¶ï¼Œæ¥æ”¶ä¸€ä¸ªTicketç±»å‹çš„
        //å‚æ•°ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ç±»çš„æˆå‘˜å˜é‡ticketã€‚
        this.ticket = ticket;
    }

    @Override
    public void run() {
        /*
         * run()æ–¹æ³•æ˜¯Runnableæ¥å£å¿…é¡»å®ç°çš„æ–¹æ³•ï¼Œ
         * å®ƒå®šä¹‰äº†çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ
         * run()æ–¹æ³•é€šè¿‡å¾ªç¯è°ƒç”¨ticket.saleTick()æ–¹æ³•11æ¬¡ï¼Œ
         * æ¨¡æ‹Ÿäº†çª—å£å–å‡ºç…é¥¼æœå­çš„è¿‡ç¨‹ã€‚æ¯æ¬¡è°ƒç”¨saleTick()æ–¹æ³•æ—¶ï¼Œ
         * éƒ½ä¼šå°è¯•å‡å°‘ç…é¥¼æœå­çš„æ•°é‡ï¼Œå¹¶è¾“å‡ºå½“å‰çº¿ç¨‹åå’Œå‰©ä½™æ•°é‡
         * */
        for (int i = 0; i < 11; i++) {
            ticket.saleTick();
        }
    }
}
```

```java
/*
* æµ‹è¯•ç±»
* */
public class SaleTickWindowTest {
    public static void main(String[] args) {
        Runnable r = new SaleTickWindow(new Ticket());
        //é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªRunnableå¯¹è±¡rï¼Œå¹¶å°†ä¸€ä¸ªæ–°çš„Ticketå¯¹è±¡ä¼ é€’ç»™SaleTickWindowæ„é€ å‡½æ•°
        Thread t0 = new Thread(r);
        Thread t1 = new Thread(r);
        Thread t2 = new Thread(r);
        //åˆ›å»ºäº†ä¸‰ä¸ªçº¿ç¨‹t0ã€t1å’Œt2ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä½¿ç”¨ç›¸åŒçš„Runnableå¯¹è±¡rä½œä¸ºå…¶ä»»åŠ¡ã€‚
        t0.start();
        t1.start();
        t2.start();
        //è°ƒç”¨æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„start()æ–¹æ³•æ¥å¯åŠ¨è¿™äº›çº¿ç¨‹ã€‚
        //è¿™å°†å¯¼è‡´å®ƒä»¬å¹¶å‘åœ°æ‰§è¡Œrun()æ–¹æ³•ä¸­çš„ä»£ç ï¼Œ
        //å³SaleTickWindowç±»çš„run()æ–¹æ³•ã€‚
    }
}
```

## æ­¥éª¤æ€»ç»“ï¼š

### 1ã€åˆ›å»ºèµ„æºç±»ï¼Œæ ¹æ®å‚è€ƒjavaBeanå®šä¹‰è§„èŒƒï¼Œå®šä¹‰èµ„æºç±»ï¼›è¿˜è¦åˆ›å»ºLockğŸ”’æ¥å£å’Œè‡ªå®šä¹‰å¤„ç†èµ„æºçš„æ–¹æ³•ï¼ˆç­‰æ•ˆäºä¹‹å‰å®šä¹‰è¿‡çš„åŒæ­¥å‡½æ•°ï¼‰

### 2ã€åˆ›å»ºç±»å®ç°å¤šçº¿ç¨‹çš„æ“ä½œï¼Œåœ¨è¯¥ç±»ä¸­ä¾èµ–æ³¨å…¥èµ„æºç±»ï¼Œåœ¨é‡å†™çš„å¤šçº¿ç¨‹çš„æ“ä½œæ–¹æ³•ä¸­ï¼Œé€šè¿‡èµ„æºç±»å¯¹è±¡è°ƒç”¨æ“ä½œèµ„æºçš„æ–¹æ³•

### 3ã€åˆ›å»ºæµ‹è¯•ç±»ï¼Œåœ¨æµ‹è¯•ç±»ä¸­å¼€å¯å¤šçº¿ç¨‹çš„æ“ä½œ

## ***ä¼šä½¿ç”¨Locké”æ¥å£è§£å†³å¤šçº¿ç¨‹ä»£ç å®‰å…¨éšæ‚£é—®é¢˜***





# çº¿ç¨‹é—´çš„é€šè®¯ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼

## å¤šä¸ªçº¿ç¨‹ä¹‹é—´è¿›è¡ŒååŒå·¥ä½œï¼Œæ“ä½œçš„æ˜¯å…±åŒçš„èµ„æº

## question : å¤šä¸ªçº¿ç¨‹åœ¨â€æŠ¢å â€œCPUçš„æ‰§è¡Œæƒï¼Œä¿è¯å¤šä¸ªçº¿ç¨‹æ‰§è¡Œçš„å…ˆåé¡ºåº

## å¸¸è§æ¡ˆä¾‹ ï¼šç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªç”Ÿäº§ï¼Œä¸€ä¸ªæ¶ˆè´¹ï¼Œæ“ä½œçš„æ˜¯åŒä¸€ä¸ªèµ„æºï¼Œè¦æœ‰æ‰§è¡Œçš„å…ˆåé¡ºåºå’Œä»£ç å®‰å…¨é—®é¢˜ï¼‰

## want : åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œå®ç°å¯¹ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„å˜é‡è¿›è¡Œ+1(ç”Ÿäº§è€…)å’Œ-1ï¼ˆæ¶ˆè´¹è€…ï¼‰äº¤æ›¿æ“ä½œ

#### *<u>åˆ†æï¼š</u>*

#### *<u>å‡è®¾ç”Ÿäº§è€…è·å–æ‰§è¡Œæƒï¼Œç›´æ¥æ‰§è¡Œï¼›</u>*

#### *<u>æ¶ˆè´¹è€…è·å–æ‰§è¡Œæƒï¼Œéœ€è¦ç­‰å¾…ï¼Œå”¤é†’ç”Ÿäº§è€…è¿›è¡Œç”Ÿäº§ï¼Œç”Ÿäº§ç»“æŸåï¼›</u>*

#### *<u>å”¤é†’æ¶ˆè´¹è€…æ¶ˆè´¹  â€”â€”  æ— è®ºæ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œéƒ½éœ€è¦ç­‰å¾…å”¤é†’ï¼Œç­‰å¾…æ˜¯è®©è‡ªå·±ç­‰å¾…ï¼Œå”¤é†’æ˜¯å”¤é†’çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹</u>*



# ç”¨ä¼ ç»Ÿæ–¹å¼synchronized+wait+notifyAllç»„åˆå®ç°ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹é—®é¢˜

```java
/*
 * Dataå…±åŒèµ„æº
 * */
public class Data {
    private int num = 0;
    //å…±äº«èµ„æºæ˜¯ä¸€ä¸ªæ•´æ•°å˜é‡numï¼Œåˆå§‹å€¼ä¸º0

    //add()æ–¹æ³•æ¨¡æ‹Ÿç”Ÿäº§è€…çš„è¡Œä¸º
    public synchronized void add() {
        try {//åˆ¤æ–­å…±åŒèµ„æºæ˜¯å¦æœ‰å€¼
            if (num != 0) {
                //ç”Ÿäº§è€…ç­‰å¾…-è°ƒç”¨wait()æ–¹æ³•
                this.wait();
            }
            /*
             * ç›´åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹äº†èµ„æºï¼ˆå³numå˜ä¸º0ï¼‰ã€‚
             * ä¸€æ—¦numä¸º0ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°†è®¾ç½®å…¶åç§°ä¸º"ç”Ÿäº§è€…"
             * */
            //è®¾ç½®å½“å‰çº¿ç¨‹åç§°ä¸ºç”Ÿäº§è€…-è¿›è¡Œå…±åŒèµ„æºçš„ç”Ÿäº§
            Thread.currentThread().setName("ç”Ÿäº§è€…");
            num++;
            //å¢åŠ numçš„å€¼å¹¶æ‰“å°å‡ºæ¥ï¼Œç„¶åé€šè¿‡è°ƒç”¨notify()æ–¹æ³•
            System.out.println(Thread.currentThread().getName() + " => " + num);
            //å”¤é†’çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹ - å”¤é†’å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹ã€‚
            this.notifyAll();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    //æ¶ˆè´¹è€…
    public synchronized void subtract() {
        try {//åˆ¤æ–­å…±åŒèµ„æºæ˜¯å¦æœ‰å€¼
            if (num == 0) {//å½“numä¸ä¸º0æ—¶
                //æ¶ˆè´¹è€…ç­‰å¾…
                this.wait();
                //ç›´åˆ°ç”Ÿäº§è€…ç”Ÿäº§äº†æ–°çš„èµ„æºï¼ˆå³numå˜ä¸ºéé›¶å€¼ï¼‰
            }
            //è®¾ç½®å½“å‰çº¿ç¨‹åç§°ä¸ºæ¶ˆè´¹è€… â€” ä¸€æ—¦numä¸ä¸º0ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹å°†è®¾ç½®å…¶åç§°ä¸º"æ¶ˆè´¹è€…"
            Thread.currentThread().setName("æ¶ˆè´¹è€…");
            //è¿›è¡Œå…±åŒèµ„æºçš„æ¶ˆè´¹ â€” å‡å°‘numçš„å€¼å¹¶æ‰“å°å‡ºæ¥
            num--;
            System.out.println(Thread.currentThread().getName() + " => " + num);
            //å”¤é†’çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹-ç„¶åé€šè¿‡è°ƒç”¨notify()æ–¹æ³•å”¤é†’å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹ã€‚
            this.notifyAll();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
/*
 * è¿™ä¸ªç®€å•çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹å¯ä»¥ç”¨äºæ¼”ç¤ºå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„åŒæ­¥å’Œäº’æ–¥æ¦‚å¿µï¼Œ
 * ä»¥åŠå¦‚ä½•ä½¿ç”¨wait()å’Œnotify()æ–¹æ³•æ¥å®ç°çº¿ç¨‹é—´çš„åä½œã€‚
 * */
```

```java
/*
* ç®€å•çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªçº¿ç¨‹t0å’Œt1ã€‚
* çº¿ç¨‹t0è´Ÿè´£ç”Ÿäº§æ•°æ®ï¼Œé€šè¿‡è°ƒç”¨dataå¯¹è±¡çš„add()æ–¹æ³•ï¼›
* çº¿ç¨‹t1è´Ÿè´£æ¶ˆè´¹æ•°æ®ï¼Œé€šè¿‡è°ƒç”¨dataå¯¹è±¡çš„subtract()æ–¹æ³•ã€‚
* è¿™ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰§è¡Œ11æ¬¡æ“ä½œï¼Œæ€»å…±è¿›è¡Œ22æ¬¡æ“ä½œã€‚
* */
public class SynchronizedWaitNotifyAllTest {
    public static void main(String[] args) {
        Data data = new Data();
        //ç”Ÿäº§è€…
        Thread t0 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 11; i++) {
                    data.add();
                }
            }
        });
        //æ¶ˆè´¹è€…
        Thread t1 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 11; i++) {
                    data.subtract();
                }
            }
        });
        t0.start();
        t1.start();
    }
}
```

![image-20240716235202286](img/image-20240716235202286.png)

# é¢è¯•é¢˜ï¼š

## ç®€è¿°Sleepæ–¹æ³•å’Œwaitæ–¹æ³•çš„å¼‚åŒç‚¹ï¼š

#### ç›¸åŒç‚¹:å½“çº¿ç¨‹æ‰§è¡Œåˆ°sleepæ–¹æ³•æˆ–waitæ–¹æ³•æ—¶ï¼Œéƒ½ä¸ä¼šç»§ç»­å‘åæ‰§è¡Œï¼Œç”±è¿è¡ŒçŠ¶æ€è½¬ä¸ºé˜»å¡çŠ¶æ€ï¼Œè¿›å…¥åˆ°çº¿ç¨‹æ± ä¸­å­˜å‚¨

#### ä¸åŒç‚¹:sleepæ–¹æ³•:åˆ°æ—¶è‡ªåŠ¨é†’æ¥ï¼Œä½†æ˜¯ä¸ä¼šé‡Šæ”¾é”å¯¹è±¡waitæ–¹æ³•:éœ€è¦é…åˆæŒ‡å®šæ–¹æ³•è¿›è¡Œæ‰‹åŠ¨å”¤é†’ï¼Œä½†æ˜¯ä¼šé‡Šæ”¾é”å¯¹è±¡





# å‡é†’é—®é¢˜ï¼š

## éœ€æ±‚å‡çº§ï¼šå†æ¬¡åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…

### 	â‘ æ³¨é‡Šæ‰èµ„æºç±»ä¸­è®¾ç½®çº¿ç¨‹åçš„æ“ä½œ

### 	â‘¡æµ‹è¯•ç±»ä¸­å†æ¬¡åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…

```java
/*
 * Dataå…±åŒèµ„æº
 * */
public class Data {
    private int num = 0;
    //å…±äº«èµ„æºæ˜¯ä¸€ä¸ªæ•´æ•°å˜é‡numï¼Œåˆå§‹å€¼ä¸º0

    //add()æ–¹æ³•æ¨¡æ‹Ÿç”Ÿäº§è€…çš„è¡Œä¸º
    public synchronized void add() {
        try {//åˆ¤æ–­å…±åŒèµ„æºæ˜¯å¦æœ‰å€¼
            if (num != 0) {
                //ç”Ÿäº§è€…ç­‰å¾…-è°ƒç”¨wait()æ–¹æ³•
                this.wait();
            }
            /*
             * ç›´åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹äº†èµ„æºï¼ˆå³numå˜ä¸º0ï¼‰ã€‚
             * ä¸€æ—¦numä¸º0ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°†è®¾ç½®å…¶åç§°ä¸º"ç”Ÿäº§è€…"
             * */
            //è®¾ç½®å½“å‰çº¿ç¨‹åç§°ä¸ºç”Ÿäº§è€…-è¿›è¡Œå…±åŒèµ„æºçš„ç”Ÿäº§
            //Thread.currentThread().setName("ç”Ÿäº§è€…");
            num++;
            //å¢åŠ numçš„å€¼å¹¶æ‰“å°å‡ºæ¥ï¼Œç„¶åé€šè¿‡è°ƒç”¨notify()æ–¹æ³•
            System.out.println(Thread.currentThread().getName() + " => " + num);
            //å”¤é†’çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹ - å”¤é†’å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹ã€‚
            this.notifyAll();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    //æ¶ˆè´¹è€…
    public synchronized void subtract() {
        try {//åˆ¤æ–­å…±åŒèµ„æºæ˜¯å¦æœ‰å€¼
            if (num == 0) {//å½“numä¸ä¸º0æ—¶
                //æ¶ˆè´¹è€…ç­‰å¾…
                this.wait();
                //ç›´åˆ°ç”Ÿäº§è€…ç”Ÿäº§äº†æ–°çš„èµ„æºï¼ˆå³numå˜ä¸ºéé›¶å€¼ï¼‰
            }
            //è®¾ç½®å½“å‰çº¿ç¨‹åç§°ä¸ºæ¶ˆè´¹è€… â€” ä¸€æ—¦numä¸ä¸º0ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹å°†è®¾ç½®å…¶åç§°ä¸º"æ¶ˆè´¹è€…"
            //Thread.currentThread().setName("æ¶ˆè´¹è€…");
            //è¿›è¡Œå…±åŒèµ„æºçš„æ¶ˆè´¹ â€” å‡å°‘numçš„å€¼å¹¶æ‰“å°å‡ºæ¥
            num--;
            System.out.println(Thread.currentThread().getName() + " => " + num);
            //å”¤é†’çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹-ç„¶åé€šè¿‡è°ƒç”¨notify()æ–¹æ³•å”¤é†’å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹ã€‚
            this.notifyAll();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
/*
 * è¿™ä¸ªç®€å•çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹å¯ä»¥ç”¨äºæ¼”ç¤ºå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„åŒæ­¥å’Œäº’æ–¥æ¦‚å¿µï¼Œ
 * ä»¥åŠå¦‚ä½•ä½¿ç”¨wait()å’Œnotify()æ–¹æ³•æ¥å®ç°çº¿ç¨‹é—´çš„åä½œã€‚
 * */
```

```java
public class SynchronizedWaitNotifyAllTest {
    public static void main(String[] args) {
        Data data = new Data();
        //ç”Ÿäº§è€…
        Thread t0 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 1; i < 11; i++) {
                    data.add();
                }
            }
        },"ç”Ÿäº§è€…A");//ğŸ‘ˆ
        //æ¶ˆè´¹è€…
        Thread t1 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 1; i < 11; i++) {
                    data.subtract();
                }
            }
        },"æ¶ˆè´¹è€…A");//ğŸ‘ˆ
        //ç”Ÿäº§è€…
        Thread t2 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 1; i < 11; i++) {
                    data.add();
                }
            }
        },"ç”Ÿäº§è€…B");//ğŸ‘ˆ
        //æ¶ˆè´¹è€…
        Thread t3 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 1; i < 11; i++) {
                    data.subtract();
                }
            }
        },"æ¶ˆè´¹è€…B");//ğŸ‘ˆ
        t0.start();
        t1.start();
        t2.start();
        t3.start();
    }
}
```

![image-20240716235109432](img/image-20240716235109432.png)

### ç»“æœåˆ†æ:æ— è®ºæ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œéƒ½æ˜¯é€šè¿‡notifyAllæ–¹æ³•è¿›è¡Œå”¤é†’è¿™ä¸ªæ–¹æ³•å°†ä¼šå”¤é†’å¤„äºé˜»å¡çŠ¶æ€ä¸‹çš„æ‰€æœ‰çº¿ç¨‹;ç”±äºä¹‹å‰çš„çº¿ç¨‹è¿›å…¥åˆ°é˜»å¡çŠ¶æ€æ˜¯ä»waitæ–¹æ³•å¼€å§‹ï¼Œå› æ­¤å†æ¬¡è¢«å”¤é†’åï¼Œä¸éœ€è¦åˆ¤æ–­å€¼ï¼Œç›´æ¥å‘åç»§ç»­æ‰§è¡Œï¼Œå› æ­¤å‡ºç°é”™è¯¯ç»“æœ

### è§£å†³åŠæ³•:å½“è¢«å”¤é†’åï¼Œéœ€è¦å†æ¬¡åˆ¤æ–­ï¼Œä½¿ç”¨å¾ªç¯;ç”±äºä¸çŸ¥é“åˆ¤æ–­å¤šå°‘æ¬¡ï¼Œå› æ­¤æ¨èä½¿ç”¨whileå¾ªç¯

```java
/*
 * Dataå…±åŒèµ„æº
 * */
public class Data {
    private int num = 0;
    //å…±äº«èµ„æºæ˜¯ä¸€ä¸ªæ•´æ•°å˜é‡numï¼Œåˆå§‹å€¼ä¸º0

    //add()æ–¹æ³•æ¨¡æ‹Ÿç”Ÿäº§è€…çš„è¡Œä¸º
    public synchronized void add() {
        try {//åˆ¤æ–­å…±åŒèµ„æºæ˜¯å¦æœ‰å€¼
            while (num != 0) {
                //ç”Ÿäº§è€…ç­‰å¾…-è°ƒç”¨wait()æ–¹æ³•
                this.wait();
            }
            /*
             * ç›´åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹äº†èµ„æºï¼ˆå³numå˜ä¸º0ï¼‰ã€‚
             * ä¸€æ—¦numä¸º0ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°†è®¾ç½®å…¶åç§°ä¸º"ç”Ÿäº§è€…"
             * */
            //è®¾ç½®å½“å‰çº¿ç¨‹åç§°ä¸ºç”Ÿäº§è€…-è¿›è¡Œå…±åŒèµ„æºçš„ç”Ÿäº§
            //Thread.currentThread().setName("ç”Ÿäº§è€…");
            num++;
            //å¢åŠ numçš„å€¼å¹¶æ‰“å°å‡ºæ¥ï¼Œç„¶åé€šè¿‡è°ƒç”¨notify()æ–¹æ³•
            System.out.println(Thread.currentThread().getName() + " => " + num);
            //å”¤é†’çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹ - å”¤é†’å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹ã€‚
            this.notifyAll();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    //æ¶ˆè´¹è€…
    public synchronized void subtract() {
        try {//åˆ¤æ–­å…±åŒèµ„æºæ˜¯å¦æœ‰å€¼
            while (num == 0) {//å½“numä¸ä¸º0æ—¶
                //æ¶ˆè´¹è€…ç­‰å¾…
                this.wait();
                //ç›´åˆ°ç”Ÿäº§è€…ç”Ÿäº§äº†æ–°çš„èµ„æºï¼ˆå³numå˜ä¸ºéé›¶å€¼ï¼‰
            }
            //è®¾ç½®å½“å‰çº¿ç¨‹åç§°ä¸ºæ¶ˆè´¹è€… â€” ä¸€æ—¦numä¸ä¸º0ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹å°†è®¾ç½®å…¶åç§°ä¸º"æ¶ˆè´¹è€…"
            //Thread.currentThread().setName("æ¶ˆè´¹è€…");
            //è¿›è¡Œå…±åŒèµ„æºçš„æ¶ˆè´¹ â€” å‡å°‘numçš„å€¼å¹¶æ‰“å°å‡ºæ¥
            num--;
            System.out.println(Thread.currentThread().getName() + " => " + num);
            //å”¤é†’çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹-ç„¶åé€šè¿‡è°ƒç”¨notify()æ–¹æ³•å”¤é†’å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹ã€‚
            this.notifyAll();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```





# ä½¿ç”¨JUCæ–¹å¼ç¼–å†™ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹

## åŸå› ï¼šä¼ ç»Ÿæ–¹å¼éœ€è¦whileå¾ªç¯ï¼Œæ¥é¿å…å‡é†’é—®é¢˜æ‰§è¡Œæ•ˆç‡ä½

## æŠ€æœ¯æ ˆ :  Locké”æ¥å£(å¹³æ›¿synchronizedåŒæ­¥)+awaitæ–¹æ³•(å¹³æ›¿waitæ–¹æ³•)+signalAll(å¹³æ›¿notifyAllæ–¹æ³•)

## Conditionæ¥å£ï¼šæä¾›æ»¡è¶³æŸç§æ¡ä»¶æˆ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œçº¿ç¨‹å¯ä»¥ç­‰å¾…æˆ–å”¤é†’æ“ä½œï¼Œé€šå¸¸Conditionæ¥å£å’ŒReentrantLockç±»ç»„åˆä½¿ç”¨ï¼Œå®ç°æ›´å¤æ‚çš„çº¿ç¨‹åŒæ­¥é€šè®¯æ“ä½œ

```java
//èµ„æºç±»
public class DataByJUC {
    private int num = 0;
    private Lock lock = new ReentrantLock();

    //ä¸ºçº¿ç¨‹æä¾›ç­‰å¾…æˆ–å”¤é†’çš„æ“ä½œ
    private Condition condition = lock.newCondition();

    //ç”Ÿäº§è€…
    public void add() {
        lock.lock();
        try {
            while (num == 1) {
                condition.await();//ç­‰å¾…
            }
            num++;
            System.out.println(Thread.currentThread().getName() + " => " + num);
            condition.signalAll();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
    //æ¶ˆè´¹è€…
    public void subtract() {
        lock.lock();
        try {
            while (num == 0) {
                condition.await();//ç­‰å¾…
            }
            num--;
            System.out.println(Thread.currentThread().getName() + " => " + num);
            condition.signalAll();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}
```

```java
//æµ‹è¯•ç±»
public class JUCTest {
    public static void main(String[] args) {
        DataByJUC data = new DataByJUC();
        //ç”Ÿäº§è€…
        Thread t0 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 1; i < 11; i++) {
                    data.add();
                }
            }
        }, "ç”Ÿäº§è€…A");//ğŸ‘ˆ
        //æ¶ˆè´¹è€…
        Thread t1 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 1; i < 11; i++) {
                    data.subtract();
                }
            }
        }, "æ¶ˆè´¹è€…A");//ğŸ‘ˆ
        //ç”Ÿäº§è€…
        Thread t2 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 1; i < 11; i++) {
                    data.add();
                }
            }
        }, "ç”Ÿäº§è€…B");//ğŸ‘ˆ
        //æ¶ˆè´¹è€…
        Thread t3 = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 1; i < 11; i++) {
                    data.subtract();
                }
            }
        }, "æ¶ˆè´¹è€…B");//ğŸ‘ˆ
        t0.start();
        t1.start();
        t2.start();
        t3.start();
    }
}
```





# çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼ï¼ˆ4ç§ï¼ŒæŒæ¡å‰3ç§ï¼‰

## ç›®å‰æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹å­˜åœ¨çš„é—®é¢˜ï¼š

## 1ã€åˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹éœ€è¦ç¡¬ä»¶æ‰§è¡Œï¼Œæ¶ˆè€—æ—¶é—´

## 2ã€çº¿ç¨‹çš„åˆ›å»º å’Œ é”€æ¯å®¹æ˜“å¼•èµ·å†…å­˜æŠ–åŠ¨ï¼Œè§¦å‘GCï¼ˆåƒåœ¾å›æ”¶å¤„ç†æœºåˆ¶ï¼‰å®¹æ˜“é€ æˆå¡é¡¿



## è§£å†³åŠæ³•â€”â€”â€œæ± â€æŠ€æœ¯ï¼š

### ä½¿ç”¨çš„æ˜¯çº¿ç¨‹æ± ï¼ˆThread Poolï¼‰æŠ€æœ¯ï¼Œæ‰€è°“çº¿ç¨‹æ± æ˜¯ä¸€ç§å¤šçº¿ç¨‹ä½¿ç”¨æ¨¡å¼ï¼Œé™ä½å¤šä¸ªçº¿ç¨‹åˆ›å»º å’Œ é”€æ¯è¿‡ç¨‹ä¸­å¸¦æ¥çš„è°ƒåº¦å¼€é”€ï¼Œä»è€Œæé«˜æ€§èƒ½ï¼›çº¿ç¨‹æ± ä¸­å¯ä»¥åŒæ—¶å­˜å‚¨å¤šä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œç­‰å¾…è¿™è°ƒç”¨è€…åˆ†é…ä»»åŠ¡ï¼Œå¯ä»¥é¿å…åœ¨å¤„ç†çŸ­æ—¶é—´ä»»åŠ¡æ—¶åˆ›å»º å’Œ é”€æ¯ä»£ä»·ï¼Œä¸ä»…èƒ½å¤Ÿä¿è¯å†…æ ¸å……åˆ†åˆ©ç”¨ï¼Œè¿˜èƒ½é˜²æ­¢è¿‡åˆ†è°ƒç”¨



## åº”ç”¨æ ¸å¿ƒ

### 1ã€å››å¤§æ–¹æ³•â€”â€”åˆ›å»ºçº¿ç¨‹æ± 

### 2ã€ä¸ƒå¤§å‚æ•°â€”â€”é…ç½®çº¿ç¨‹æ± 

### 3ã€å››å¤§æ‹’ç»ç­–ç•¥â€”â€”é˜²æ­¢è¿‡åº¦è°ƒç”¨



# åˆ›å»ºæ–¹å¼ï¼šéƒ½æ˜¯ç”±JUCåŒ…ä¸‹æä¾›Executorså·¥å…·ç±»æä¾›çš„æ–¹æ³•åˆ›å»º

## æ–¹å¼ä¸€ï¼š

```java
public class CreateThreadPoolTest1 {
    public static void main(String[] args) {
        /*
         * æ–¹å¼ä¸€ï¼š
         *   newFixedThreadPool(int nThreads)
         *   ä¸€æ± Nä¸ªçº¿æ± ï¼Œå‚æ•°è¡¨ç¤ºçº¿ç¨‹å¯¹è±¡çš„åˆå§‹ä¸ªæ•°
         * */
        ExecutorService pool = Executors.newFixedThreadPool(4);
        for (int i = 0; i < 11; i++) {
            int TaskNo = 1;
            pool.execute(new Runnable() {
                @Override
                public void run() {
                    System.out.println(Thread.currentThread().getName() + "=>" + TaskNo);
                }
            });
        }
        //é”€æ¯çº¿ç¨‹æ± 
        pool.shutdown();
    }
}
```

## æ–¹å¼äºŒï¼š

```java
public class CreateThreadPoolTest2 {
    public static void main(String[] args) {
        /*
         * æ–¹å¼äºŒï¼š
         *   newCachedThreadPool()
         *   å¯ä¼¸ç¼©çº¿ç¨‹æ± ï¼Œä¸Šé™21äº¿ï¼Œæ ¹æ®ç”µè„‘çš„å…·ä½“æ€§èƒ½ä½¿ç”¨
         * */
        ExecutorService pool = Executors.newCachedThreadPool();
        for (int i = 0; i < 11; i++) {
            int TaskNo = 1;
            pool.execute(new Runnable() {
                @Override
                public void run() {
                    System.out.println(Thread.currentThread().getName() + "=>" + TaskNo);
                }
            });
        }
        //é”€æ¯çº¿ç¨‹æ± 
        pool.shutdown();
    }
}
```

## æ–¹å¼ä¸‰ï¼š

```java
public class CreateThreadPoolTest3 {
    public static void main(String[] args) {
        /*
         * æ–¹å¼ä¸‰ï¼š
         *   newSingleThreadExecutor()
         *   æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œæ’é˜Ÿå¤„ç†
         * */
        ExecutorService pool = Executors.newSingleThreadExecutor();
        for (int i = 0; i < 11; i++) {
            int TaskNo = 1;
            pool.execute(new Runnable() {
                @Override
                public void run() {
                    System.out.println(Thread.currentThread().getName() + "=>" + TaskNo);
                }
            });
        }
        //é”€æ¯çº¿ç¨‹æ± 
        pool.shutdown();
    }
}
```

## æ–¹å¼å››ï¼šExcutors.newScheduledThreadPool()ï¼ˆäº†è§£çŸ¥é“å³å¯ï¼‰



# çº¿ç¨‹æ± åˆ›å»ºæ­¥éª¤ï¼š

## 1ã€é€šè¿‡Excutorsç±»åè°ƒç”¨æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± 

## 2ã€åœ¨çº¿ç¨‹æ± ä¸­åˆ†é…å¤šçº¿ç¨‹äººç‰©

## 3ã€ä¸€å®šé”€æ¯çº¿ç¨‹æ± 



# çº¿ç¨‹æ± 7å¤§å‚æ•°+4å¤§å¸¸è§ç­–ç•¥æ¨¡å¼

# çº¿ç¨‹æ± 7å¤§å‚æ•°

```java
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue,
                          ThreadFactory threadFactory,
                          RejectedExecutionHandler handler)
```

### 1ã€int corePoolSize:æ ¸å¿ƒçº¿ç¨‹æ± ä¸­ä¸€ç›´æ´»ç€çš„å¯¹è±¡ï¼Œå½“éœ€è¦å“¦å¤šçº¿ç¨‹æ“ä½œæ—¶ï¼Œä¹Ÿæ˜¯æœ€å…ˆè¢«è°ƒç”¨çš„ï¼Œå³åˆå§‹åŒ–çº¿ç¨‹å¯¹è±¡ä¸ªæ•°

### 2ã€int maximumPoolSize:æœ€å¤§çº¿ç¨‹æ•°ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­å¯ä»¥å­˜æ´»çº¿ç¨‹å¯¹è±¡çš„æœ€å¤§ä¸ªæ•°ï¼›å½“æ ¸å¿ƒçº¿ç¨‹æ•°å…¨éƒ¨è¢«å ç”¨æ—¶ï¼Œçº¿ç¨‹æ± ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œä½†æ˜¯ä¸ä¼šè¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°

### 3ã€long keepAliveTime: çº¿ç¨‹ç©ºé—²æ—¶é—´ï¼Œéæ ¸å¿ƒçº¿ç¨‹ç­‰å¾…ä»»åŠ¡æ—¶é—´

### 4ã€TimeUtil unit:è®¾ç½®ç­‰å¾…æ—¶é—´çš„å•ä½ï¼ˆmillionæ¯«ç§’ï¼‰

### 5ã€BlockingQueue<Runnable>workQueue:æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡

### 6ã€ThreadFactory threadFactory :  çº¿ç¨‹å·¥å‚ï¼Œç”¨äºæ‰¹é‡åˆ›å»ºçº¿ç¨‹å¯¹è±¡

### 7ã€RejectedExecutionHandler handle : æ‹’ç»ç­–ç•¥ï¼Œé˜²æ­¢è¿‡åº¦è°ƒç”¨

# 4å¤§å¸¸è§ç­–ç•¥æ¨¡å¼â€”â€”å››å¤§æ‹’ç»ç­–ç•¥

## (ç†è§£)--ç­–ç•¥æ¨¡å¼(æ˜¯Javaä¸­23ç§å¸¸è§è®¾è®¡æ¨¡å¼çš„ä¸€ç§)

![image-20240716154414867](img/image-20240716154414867.png)

### 1ã€(é»˜è®¤çš„æ‹’ç»ç­–ç•¥):æŠ›å‡ºå¼‚å¸¸é˜»æ­¢ç¨‹åºè¿è¡Œï¼Œå®é™…å¼€å‘ä¸­ä½¿ç”¨è¯¥ç­–ç•¥å³å¯

### 2ã€CallerRunsPolicy:"è°ƒç”¨è€…è¿è¡Œâ€œæœºåˆ¶ï¼Œä¸æŠ›å¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œå°†ä»»åŠ¡é€€åè°ƒç”¨è€…

### 3ã€DiscardoldestPolicy:æŠ›å¼ƒæ¶ˆæ¯é˜Ÿåˆ—ä¸­ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡

### 4ã€DiscardPolicy:æŠ›å¼ƒæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ä»»åŠ¡



# æ‰‹åŠ¨åˆ›å»ºè¿æ¥æ± 

```java
public class DIYThreadPoolTest {
    public static void main(String[] args) {
        //åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡
        ThreadPoolExecutor pool = new ThreadPoolExecutor(
                3,
                4,
                30,
                TimeUnit.SECONDS,
                new LinkedBlockingDeque<>(),
                new ThreadPoolExecutor.AbortPolicy()
        );
        //ç»™çº¿ç¨‹æ± ä¸­çš„çº¿æ± åˆ†é…ä»»åŠ¡
        for (int i = 0; i < 10; i++) {
            int num = 0;
            pool.execute(new Runnable() {
                @Override
                public void run() {
                    System.out.println(Thread.currentThread().getName() + "::" + num);
                }
            });
        }
        //é”€æ¯çº¿ç¨‹æ± 
        pool.shutdown();
    }
}
/*
* åˆ›å»ºäº†ä¸€ä¸ªDIYThreadPoolTestç±»ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªmainæ–¹æ³•ã€‚åœ¨mainæ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡poolï¼Œè¯¥çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º3ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º4ï¼Œç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ä¸º30ç§’ï¼Œä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨LinkedBlockingDequeï¼Œæ‹’ç»ç­–ç•¥ä¸ºAbortPolicyã€‚

ç„¶åï¼Œé€šè¿‡forå¾ªç¯å‘çº¿ç¨‹æ± æäº¤10ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œå…¶runæ–¹æ³•æ‰“å°å½“å‰çº¿ç¨‹çš„åç§°å’Œå˜é‡numçš„å€¼ã€‚ç”±äºnumåœ¨æ¯æ¬¡å¾ªç¯ä¸­éƒ½è¢«åˆå§‹åŒ–ä¸º0ï¼Œæ‰€ä»¥æ‰€æœ‰ä»»åŠ¡æ‰“å°çš„å†…å®¹éƒ½æ˜¯ä¸€æ ·çš„ã€‚

æœ€åï¼Œè°ƒç”¨pool.shutdown()æ–¹æ³•é”€æ¯çº¿ç¨‹æ± ã€‚
* */
```







# å‘˜å·¥ç®¡ç†ç³»ç»Ÿ













